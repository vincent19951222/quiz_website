# 飞书多维表格集成指南

本文档详细介绍如何配置和使用飞书多维表格集成功能，实现答题记录的自动同步。

## 功能概述

- ✅ 自动将答题记录同步到飞书多维表格
- ✅ 实时上传新的答题结果
- ✅ 批量同步历史记录
- ✅ 连接状态检测
- ✅ 同步进度显示
- ✅ 错误处理和重试机制

## 配置步骤

### 1. 创建飞书应用

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 登录并创建企业自建应用
3. 在应用管理页面获取以下信息：
   - `App ID`
   - `App Secret`

### 2. 创建多维表格

1. 在飞书中创建一个新的多维表格
2. 设置以下字段结构：

| 字段名称 | 字段类型 | 说明 |
|---------|---------|------|
| 姓名 | 文本 | 答题者姓名 |
| 手机号 | 文本 | 答题者手机号 |
| 得分 | 数字 | 答题得分 |
| 正确率 | 数字 | 答题正确率(%) |
| 错题数 | 数字 | 答错题目数量 |
| 答题用时 | 文本 | 答题所用时间 |
| 答题时间 | 文本 | 答题时间 |
| 查看答案 | 文本 | 查看答案 |


1. 获取表格的 `app_token` 和 `table_id`：
   - 在多维表格URL中可以找到这些信息
   - URL格式：`https://xxx.feishu.cn/base/{app_token}?table={table_id}`

### 3. 配置权限

在飞书应用管理页面：

1. 进入「权限管理」
2. 添加以下权限：
   - `bitable:app` - 查看、评论、编辑和管理多维表格
   - `bitable:app:readonly` - 查看多维表格

3. 发布应用版本并通过审核

### 4. 环境变量配置

在项目根目录创建 `.env` 文件：

```env
# 飞书应用配置
VITE_FEISHU_APP_ID=your_app_id_here
VITE_FEISHU_APP_SECRET=your_app_secret_here

# 飞书多维表格配置
VITE_FEISHU_APP_TOKEN=your_app_token_here
VITE_FEISHU_TABLE_ID=your_table_id_here
```

**注意：**
- 请将 `your_app_id_here` 等占位符替换为实际的值
- 不要将 `.env` 文件提交到版本控制系统
- 生产环境请使用更安全的密钥管理方案

## 使用方法

### 自动同步

配置完成后，每当有用户完成答题，系统会自动尝试将记录上传到飞书多维表格。

### 手动同步

1. 访问管理员面板（密码：`admin123`）
2. 在「飞书多维表格同步」区域：
   - 点击「测试连接」检查配置是否正确
   - 点击「同步到飞书」批量上传历史记录

### 连接状态说明

- 🟢 **已连接**：飞书API配置正确，可以正常同步
- 🔴 **未连接**：配置有误或网络问题，需要检查配置
- 🟡 **检查中**：正在测试连接状态

## 数据结构

### 答题记录格式

```typescript
interface QuizRecord {
  name: string;           // 答题者姓名
  phone: string;          // 手机号
  score: number;          // 得分
  correctRate: number;    // 正确率
  wrongCount: number;     // 错题数
  timeUsed: string;       // 答题用时
  endTime: string;        // 答题时间（结束时间）
  answers: Array<{        // 答案详情（用于本地存储）
    question: string;
    userAnswer: string;
    correctAnswer: string;
    isCorrect: boolean;
  }>;
  // 注：查看答案状态从localStorage动态获取
}
```

### 飞书表格字段映射

| 本地字段 | 飞书字段 | 数据处理 |
|---------|---------|----------|
| name | 姓名 | 直接映射 |
| phone | 手机号 | 直接映射 |
| score | 得分 | 直接映射 |
| correctRate | 正确率 | 数字格式（不含%） |
| wrongCount | 错题数 | 直接映射 |
| timeUsed | 答题用时 | 直接映射 |
| endTime | 答题时间 | 直接映射 |
| localStorage | 查看答案 | 动态检测（是/否） |

## 故障排除

### 常见问题

1. **连接失败**
   - 检查 `.env` 文件是否存在且配置正确
   - 确认飞书应用权限已正确配置
   - 检查网络连接

2. **同步失败**
   - 查看浏览器控制台错误信息
   - 确认多维表格字段结构正确
   - 检查飞书应用是否已发布

3. **权限错误**
   - 确认应用已添加必要的多维表格权限
   - 检查应用版本是否已发布并通过审核

### 调试模式

在开发环境中，可以通过浏览器控制台查看详细的调试信息：

```javascript
// 在控制台中查看飞书API调用日志
console.log('Feishu API Debug Info');
```

## 安全考虑

1. **密钥安全**
   - 不要在代码中硬编码API密钥
   - 使用环境变量管理敏感信息
   - 定期轮换API密钥

2. **数据隐私**
   - 确保飞书应用仅有必要的权限
   - 定期审查数据访问日志
   - 遵守相关数据保护法规

3. **网络安全**
   - 使用HTTPS传输数据
   - 实施适当的错误处理
   - 避免敏感信息泄露

## 进一步优化

1. **性能优化**
   - 实施批量上传机制
   - 添加本地缓存和重试逻辑
   - 优化网络请求频率

2. **功能扩展**
   - 添加数据同步状态追踪
   - 实现增量同步
   - 支持多个表格同步

3. **监控告警**
   - 添加同步失败告警
   - 实施健康检查机制
   - 记录详细的操作日志

## 技术支持

如果在配置或使用过程中遇到问题，请：

1. 查看浏览器控制台错误信息
2. 检查飞书开放平台文档
3. 确认配置文件格式正确
4. 联系技术支持团队

---

**注意：** 本集成功能需要稳定的网络连接和正确的飞书API配置。建议在生产环境使用前进行充分测试。